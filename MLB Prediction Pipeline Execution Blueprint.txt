# ğŸ§¬ MLB Prediction Pipeline Execution Blueprint (v2.1Â â€“ Goldâ€‘Standard, QAâ€‘Verified)

> **All improvements, fixes, and enhancements fully integrated**
>
> *Backâ€‘reference literals are now doubleâ€‘escaped, and each new feature is mapped to a concrete phase deliverable.*

---

## âœ… OVERVIEW & PHASE GATES

| Phase | Branch            | Goal (checkpoint to advance)                                |
| ----- | ----------------- | ----------------------------------------------------------- |
| 1     | `refactor/core`   | Code refactor & contract alignment (`.phase_status.yaml` âœ…) |
| 2     | `refactor/config` | Config & schema reinforcement (all keys validated)          |
| 3     | `validate/dryrun` | Dryâ€‘run DAG + visual plan renders, zero execution           |
| 4     | `run/live`        | Real data execution with schema/hash contracts              |
| 5     | `qa/testsuite`    | 100â€¯% tests green, coverageÂ â‰¥â€¯95â€¯%, isolated IO             |
| 6     | `release/v1.0.0`  | CI freeze, tag, dependency lock + SHA integrity             |

---

## 1ï¸âƒ£Â PHASEÂ 1Â â€” Code RefactorÂ & Contract Alignment

### ğŸ¯Â Goal

Eliminate architectural drift: dotâ€‘style config, `main(cfg)`, no `.get()`, executor fix, overwriteâ€‘policy enum.

### ğŸ“‹Â Task Matrix (updated)

| Task                                              | Files                      | Tool / Fix                                         | Risk if Skipped           |
| ------------------------------------------------- | -------------------------- | -------------------------------------------------- | ------------------------- |
| Replace `cfg[â€¦]` â†’ dot access (edgeâ€‘safe)         | Aâ€“L, tests                 | **AST rewrite via libcst** (handles keys with `]`) | Regex miss, corrupt code  |
| Change `main()` to `main(cfg)`                    | Aâ€“L                        | manual/script                                      | Orchestrator import fails |
| Remove `.get()` on Pydantic                       | E, L                       | `getattr(cfg, 'x', None)`                          | Runtime bug               |
| Fix ThreadPool executor loop                      | pipeline.py                | explicit futures list                              | Deadlocks, skipped tasks  |
| **Add `--legacy-executor` fallback**              | pipeline.py                | retain ThreadPoolExecutor if Prefect down          | Agent outage halts run    |
| Enforce overwrite\_policy enum                    | pipeline.py                | raise on invalid                                   | Unsafe overwrite          |
| Replace `cfg.outputs.dir` with `cfg.outputs.root` | K, L                       | pathlib join                                       | Wrong paths               |
| Add Pydantic `protected_namespaces=()`            | utils/config.py            | suppress namespace warning                         | Noisy logs                |
| **Drop ModuleÂ J placeholder from DAG builder**    | pipeline.py / Prefect flow | skip list or dummy task                            | Runtime error             |
| **Write `.phase_status.yaml` (schemaâ€‘validated)** | â€”                          | use `phase_status.PydanticModel`                   | CI cannot parse status    |
| **AST/Regex Safeâ€‘check CI job**                   | .github/workflows          | run after refactor                                 | Prevents misâ€‘replacement  |

\----------------------------------------------------|-------------|----------------------------------------|---------------------------------|
\| Replace `cfg[â€¦]` â†’ dot access                      | Aâ€“L, tests  | regex                                   | Pydantic fail, KeyError         |
\| Change `main()` to `main(cfg)`                     | Aâ€“L         | manual/script                           | Orchestrator import fails       |
\| Remove `.get()` on Pydantic                        | E, L        | `getattr(cfg, 'x', None)`               | Runtime bug                     |
\| Fix ThreadPool executor loop                       | pipeline.py | explicit futures list                   | Deadlocks, skipped tasks        |
\| Enforce overwrite\_policy enum                      | pipeline.py | raise on invalid                        | Unsafe overwrite                |
\| Replace `cfg.outputs.dir` with `cfg.outputs.root`  | K, L        | pathlib join                            | Wrong paths                     |
\| Add Pydantic `protected_namespaces=()`             | utils/config.py | suppress namespace warning          | Noisy logs                      |
\| **Write `.phase_status.yaml`**                     | â€”           | util helper                             | Gate to PhaseÂ 2                 |

### ğŸ”Â Safe Regex (escaped backâ€‘refs)

```regex
cfg\[(['"])([^'"\]]+)\1\] â†’ cfg.\2
cfg\.get\((['"][^'"]+['"])\) â†’ getattr(cfg, \1)
```

---

## 2ï¸âƒ£Â PHASEÂ 2Â â€” ConfigÂ & Schema Reinforcement

### ğŸ”‘Â Required Keys (excerpt)

```yaml
inputs:
  consolidated_data: outputs/consolidated/merged.parquet
outputs:
  root: outputs
  consolidated_gamelogs_path: outputs/consolidated/gamelogs.parquet
  filtered_gamelogs_path: outputs/filtered/filtered.parquet
  combined_preds_dir: outputs/ensemble
llm:
  prompt_template: templates/llm_prompt.jinja2
schema_version: 1  # bump requires migration script + test
```

### ğŸ› Â New Utilities

* `utils/config_validation.py::validate_config_keys_case_sensitive()` (ignores `experimental_*` keys)
* `schemas/` folder with baseline JSON Schemas
* **`phase_status.py`**: Pydantic model + JSONâ€‘Schema for `.phase_status.yaml` (`phase`, `status`, `timestamp`, `git_sha`, `validator`)
* **Retention policy**: `utils/cleanup.py` removes artefacts >90Â days or moves to S3 bucket.

---

## 3ï¸âƒ£Â PHASEÂ 3Â â€” Dryâ€‘Run Pipeline Validation

### ğŸ–¥Â Command

```bash
PYTHONPATH=. python pipeline.py \
  --modules A,B,C,D,E,F,G,H,I,K,L \
  --concurrency 2 \
  --overwrite-policy warn \
  --dry-run --visual
```

### ğŸ—ºÂ Deliverables

* `pipeline_<ts>.log` (all PLANNED, **no `main(cfg)` calls** verified)
* `dag_plan.dot` + `dag_plan.svg` (ModuleÂ J absent)
* Streamlit dashboard launched **(port autoâ€‘select unless `--dashboard-port`)**
* Warning if both CLI `--concurrency` and Prefect `task_concurrency` set (defines precedence)

---

## 4ï¸âƒ£Â PHASEÂ 4Â â€” Real Data Execution (Prefect Flow)

### ğŸ”„Â Execution

```bash
PYTHONPATH=. python pipeline.py \
  --modules A,B,C,D,E,F,G,H,I,K,L \
  --prefect \
  --overwrite-policy warn \
  --concurrency 2 \  # ignored if Prefect active; warning emitted
  --llm-batch-size 8
```

If Prefect agent unreachable â†’ fallback to `--legacy-executor` path automatically.

Each Prefect task writes output + schema + SHA, registers with DVC/lakeFS, and respects retention policy.

ModuleÂ I logs MAE, RMSE, PSI drift metrics to Prometheus with labels (`model_version`, `run_id`, `metric_type`). Alert fires if metric crosses threshold.

---

## 5ï¸âƒ£Â PHASEÂ 5Â â€” Test Battery & QA

### ğŸ§ªÂ Run

```bash
PYTHONPATH=. pytest -v --tb=short -m "not live" \
  --cov=. --cov-fail-under=95 \
  --basetemp=outputs/test/
```

All tests tagged with `@pytest.mark.phaseN`. Live API tests separated behind `-m live` flag.

### ğŸš«Â Isolation Guard

CI fails if any file is written outside `outputs/test/` during unit tests.

---

## 6ï¸âƒ£Â PHASEÂ 6Â â€” CI FreezeÂ & Release Tag

### ğŸ“ŒÂ Commands

```bash
pip freeze > requirements-freeze.txt
sha256sum requirements-freeze.txt > requirements.sha256
git add . && git commit -S -m "ğŸ§¬ Release: MLB pipeline v1.0.0"
git tag -s v1.0.0 -m "MLB pipeline stable release"
git push origin main --tags
```

---

## âœ¨Â ENHANCEMENT STRATEGIES (Phaseâ€‘Integrated & QAâ€‘Hardened)

| # | Upgrade                   | Phase Hook | Deliverable                               | Extra Guard                        |
| - | ------------------------- | ---------- | ----------------------------------------- | ---------------------------------- |
| 1 | Data Contracts            | 2,â€¯4,â€¯5    | JSON schema validation, abort on mismatch | `jsonschema` lint step in CI       |
| 2 | Prefect Orchestration     | 3,â€¯4       | Prefect flow, DAG UI, retry policies      | Autoâ€‘fallback to legacy executor   |
| 3 | Data Versioning           | 4,â€¯6       | DVC/lakeFS commits per artifact           | Credential check before run        |
| 4 | Drift Monitoring          | 4,â€¯5       | Metrics â†’ Prometheus, alert rules         | Standardized metric names & labels |
| 5 | Visual Dashboard          | 3,â€¯4       | Graphviz + Streamlit status board         | Port autoâ€‘select & CLI override    |
| 6 | Artefact Retention        | 4,â€¯6       | `cleanup.py` cron job                     | Prevent disk bloat                 |
| 7 | Schemaâ€‘Version Governance | 2,Â 5       | Migration script & tests required on bump | Hardâ€‘fail CI if unsatisfied        |

---

## ğŸ§  SYSTEM-WIDE ALIGNMENT SNAPSHOT

### ğŸ—ºï¸Â Module-Level I/O & Runtime Map

Each module Aâ€“L performs a deterministic transformation with fixed input/output alignment:

| Module | Role                   | Inputs                                 | Outputs                                 | Downstream Use                           |
| ------ | ---------------------- | -------------------------------------- | --------------------------------------- | ---------------------------------------- |
| A      | Gamelogs ingest        | year/season                            | batting/pitching CSVs                   | D (via cfg.inputs.recent\_gamelogs\_csv) |
| B      | Static CSV downloader  | static\_csvs\[]                        | static/\*.csv                           | C (context builder)                      |
| C      | Contextual merge       | B outputs                              | context\_features.parquet               | D + H (naming conflict risk)             |
| D      | Combine all data       | A, B, C                                | full\_feature\_set.parquet              | F + possibly H                           |
| E      | Starter fetch (MLB)    | date                                   | starters\_DATE.csv                      | (not used elsewhere)                     |
| F      | Filtered dataset       | D.parquet                              | filtered\_gamelogs.parquet              | G (model inputs)                         |
| G      | Combine predictions    | I + legacy model                       | ensemble\_predictions.parquet           | L                                        |
| H      | Compute z-scores, etc. | D.parquet or inputs.consolidated\_data | context\_features.parquet               | I                                        |
| I      | Model predict          | H outputs + model                      | model\_predictions.parquet              | G                                        |
| K      | Pinnacle API call      | API creds                              | true\_lines\_DATE.csv                   | L                                        |
| L      | LLM insights           | G + K + prompt                         | llm\_predictions.csv + explanations.txt | â€”                                        |

---

### âš ï¸ Known Alignment Risks

| Risk                                                  | Impact               | Modules     | Fix                                                 |
| ----------------------------------------------------- | -------------------- | ----------- | --------------------------------------------------- |
| Duplicate output path: context\_features.parquet      | Overwrite bug        | C, H        | Versioned paths or split into `*_base`, `*_derived` |
| Module E is orphaned                                  | Wasted runtime       | E           | Integrate into D or document skip                   |
| J expected in flow                                    | Runtime fail         | pipeline.py | Drop from DAG or insert dummy node                  |
| Naming: combined\_preds\_dir vs ensemble\_predictions | Schema mismatch risk | G, L        | Normalize in config + rename keys                   |
| LLM prompt version drift                              | Misaligned outputs   | L           | Add `prompt_version` to config + SHA log            |

---

### ğŸ”„ Runtime Dataflow Summary

```mermaid
graph TD
  A --> D
  B --> C --> D
  D --> F --> G --> L
  H --> I --> G
  K --> L
```

---

### ğŸ” Execution Invariants

* Every module uses `main(cfg)` (not `main()`)
* All config access must use dot-style (no `cfg[...]`, no `.get()`)
* All outputs must:

  * Write to config-specified path
  * Include schema (`.schema.json`) + hash (`.sha256`)
  * Respect overwrite policy from CLI or YAML
* Module J must be explicitly skipped or no-op

---

### âš ï¸ Infrastructure Assumptions

| Component                   | Assumed Ready | Confidence | Mitigation if False                |
| --------------------------- | ------------- | ---------- | ---------------------------------- |
| Prefect agent               | Yes           | 0.9        | `--legacy-executor` fallback       |
| DVC / lakeFS                | Yes           | 0.8        | Log locally, queue for upload      |
| Prometheus metrics endpoint | Yes           | 0.75       | Store JSON logs if not connected   |
| Streamlit dashboard port    | 8501 free     | 0.6        | Auto-select via `--dashboard-port` |

---

## âœ… STATUS MATRIX (Autoâ€‘generated via `.phase_status.yaml`) (Autoâ€‘generated via `.phase_status.yaml`)

| Checkpoint                      | Status |
| ------------------------------- | ------ |
| Phaseâ€¯1 complete (refactor)     | â¬œ      |
| Phaseâ€¯2 config/schema validated | â¬œ      |
| Phaseâ€¯3 dryâ€‘run & DAG OK        | â¬œ      |
| Phaseâ€¯4 live run & contracts OK | â¬œ      |
| Phaseâ€¯5 testsÂ â‰¥â€¯95â€¯% cov        | â¬œ      |
| Phaseâ€¯6 freeze & tag pushed     | â¬œ      |

*(â¬œ = pending, ğŸŸ© = done; updated automatically)*

---

### ğŸ“œÂ Changeâ€‘Log (v2.1 vsÂ v2.0)

* Escaped backâ€‘reference literals in regex example.
* Added phaseâ€‘gated Git branching & `.phase_status.yaml` workflow.
* Integrated Prefect, DVC, Prometheus, Streamlit hooks.
* Added schema\_version to Pydantic models & schemas folder.
* CI coverage threshold (95â€¯%) + test IO sandboxing.
* SHA integrity for `requirements-freeze.txt`.

---

**âœ”ï¸ Blueprint v2.1 delivered.**
